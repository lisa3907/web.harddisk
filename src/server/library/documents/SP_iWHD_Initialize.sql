/*-----------------------------------------------------------------------------------------------*/
--Title 	: '파일공유 사용을 위한 기본정보 생성하기- SP_iWHD_Initialize'
--Author  	: 김석진
--Date 		: 2007-12-21
--NickName 	: 
--Version 	: v3.4.2007.10
/*-----------------------------------------------------------------------------------------------*/
IF EXISTS (SELECT * FROM SysObjects WHERE NAME ='SP_iWHD_Initialize') DROP PROCEDURE SP_iWHD_Initialize
Go

/*-----------------------------------------------------------------------------------------------*/
--Title 	: '파일공유 사용을 위한 기본정보 생성하기- SP_iWHD_Initialize'
/*-----------------------------------------------------------------------------------------------*/
CREATE PROCEDURE SP_iWHD_Initialize
(
	@pzCompanyID	nvarchar(64)	= '1001',
	@pzMemberID		nvarchar(64)	= 'ksj'
)
AS
/*-----------------------------------------------------------------------------------------------*/
--
/*-----------------------------------------------------------------------------------------------*/
BEGIN
SET NOCOUNT ON

DECLARE	@szRootID	nvarchar(64),	@szMemberName	nvarchar(64),	@ivReturn	decimal(5),
        @ivResult	decimal(5), @szCompanyName nvarchar(32)

/*-----------------------------------------------------------------------------------------------*/
-- 
/*-----------------------------------------------------------------------------------------------*/
BEGIN TRANSACTION

	/*-------------------------------------------------------------------------------------------*/
	-- 01) 파라미터 값들에 이상이 있을 경우 종료합니다.
	/*-------------------------------------------------------------------------------------------*/
	IF (ISNULL(@pzCompanyID, '') = '' OR ISNULL(@pzMemberID, '') = '')
	BEGIN
		SET @ivReturn = 1
		GOTO E_FAILED
	END

	/*-------------------------------------------------------------------------------------------*/
	--
	/*-------------------------------------------------------------------------------------------*/
	SET	@ivResult = -1

	SET @szRootID = newid()

	/*-------------------------------------------------------------------------------------------*/
	-- 멤버 이름을 가져옵니다.
	/*-------------------------------------------------------------------------------------------*/
	SELECT @szMemberName = ISNULL(name, '')
	FROM   TB_iORG_MEMBER
	WHERE  companyid = @pzCompanyID AND memberid = @pzMemberID
	
	/*-------------------------------------------------------------------------------------------*/
	-- 회사 이름을 가져옵니다.
	/*-------------------------------------------------------------------------------------------*/
	SELECT @szCompanyName = ISNULL(biz_name, 'ROOT')
	FROM TB_iCTL_COMPANY
	WHERE companyid = @pzCompanyID	
	
	/*-------------------------------------------------------------------------------------------*/
	-- TB_iWHD_DIRECTORY
	/*-------------------------------------------------------------------------------------------*/
	INSERT INTO TB_iWHD_DIRECTORY
	(
		guid, companyid, fileid, ftype, vsize, vtype, rname, title, description, attach, wcode, wname, wdate
	)
	VALUES
	(
		@szRootID, @pzCompanyID, '0001', 'T', 0, '', @szCompanyName, '', '', '', @pzMemberID, @szMemberName, getdate()
	)

	IF (@@ERROR != 0)
	BEGIN
		SET @ivReturn = 2
		GOTO E_FAILED
	END

	/*-------------------------------------------------------------------------------------------*/
	-- TB_iWHD_AUTHORITY
	/*-------------------------------------------------------------------------------------------*/
	INSERT INTO TB_iWHD_AUTHORITY
	(
		guid, member, mtype, name, control, cmodify, cread, cdelete, cview, cfolder, cfile
	)
	VALUES
	(
		@szRootID, @pzMemberID, 'F', @szMemberName, 'T', 'T', 'T', 'T', 'T', 'T', 'T'
	)

	IF (@@ERROR != 0)
	BEGIN
		SET @ivReturn = 3
		GOTO E_FAILED
	END

	/*-------------------------------------------------------------------------------------------*/
	--
	/*-------------------------------------------------------------------------------------------*/
	SET @ivResult = 0

	SELECT @ivResult

	/*-------------------------------------------------------------------------------------------*/
	--
	/*-------------------------------------------------------------------------------------------*/
E_SUCCESS:
COMMIT TRANSACTION
RETURN(0)
	
E_FAILED:
ROLLBACK TRANSACTION
RETURN(@ivReturn)
	
/*-----------------------------------------------------------------------------------------------*/
--
/*-----------------------------------------------------------------------------------------------*/
END;
GO